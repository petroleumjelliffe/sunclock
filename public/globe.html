<html>
<head>


  <script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
  <script   src="./js/analog-clock.js"   crossorigin="anonymous"></script>


  <style>

  body {
  background: #fcfcfa;
  }

  .stroke {
  fill: none;
  stroke: #333;
  stroke-width: 3px;
  }

  .fill {
    fill:#fff;

  }

  .graticule {
  fill: none;
  stroke: #777;
  stroke-width: .5px;
  stroke-opacity: .5;
  }

  .land {
  fill: #222;
  }

  .boundary {
  fill: none;
  stroke: #fff;
  stroke-width: .5px;
  }

  </style>
</head>

<body>

  <script src="//d3js.org/d3.v3.min.js"></script>
  <script src="//d3js.org/topojson.v1.min.js"></script>
  <script>

  var width = 200,
      height = 200;

  var solstice = new Date(2016,11,21,5,44)
  var now = new Date()
  var psi = (now.getTime() - solstice.getTime())/1000/60/60/24/365.2389*Math.PI*2
  psi=Math.PI/6*3
  console.log(psi);
  var projection = d3.geo.orthographic()
      .scale(50)
      .translate([width / 2, height / 2])
      .rotate([90+90,+23.4*Math.sin(psi),90+23.4*Math.cos(psi)])
      .clipAngle(90)
      // .clipExtent([[150,0],[250,300]])
      // .clipExtent([[0,0],[250,300]])
      .precision(.1);

  var path = d3.geo.path()
      .projection(projection);

  var graticule = d3.geo.graticule();

  var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

  svg.append("defs").append("path")
      .datum({type: "Sphere"})
      .attr("id", "sphere")
      .attr("d", path);

  // var grad = svg.append("defs")
  //       .append("linearGradient")
  //       .attr("id", "grad")
  //     grad.append("stop").attr("offset", "0%").style("stop-color", "white");
  //     grad.append("stop").attr("offset", "50%").style("stop-color", "blue");
  //     grad.append("stop").attr("offset", "100%").style("stop-color", "blue");


  svg.append("use")
      .attr("class", "stroke")
      .attr("xlink:href", "#sphere");


  svg.append("use")
      .attr("class", "fill")
      .attr("xlink:href", "#sphere")
      .attr(" transform", "translate(10,10)")

  var abc = svg.append("path")
      .datum(graticule)
      .attr("class", "graticule")
      .attr("d", path);

  var map= {
    geometry: {
      coordinates:[],
      type:"MultiPolygon"
    },
    type: "Feature"
  }
  var map2=svg.append("path")
    .datum(map)
    .attr("class", "land")
    .attr("d", path);

function matrix(tx, ty) {
  return d3.geoTransform({
    point: function(x, y) {
      this.stream.point(x+ tx, y + ty);
    }
  });
}


  d3.json("./js/world-50m.json", function(error, world) {
    if (error) throw error;
    map = topojson.feature(world, world.objects.land)
    .attr("transform", "translate(10,10)")

    console.log(map);

    map2 = svg.insert("path", ".graticule")
        .datum(topojson.feature(world, world.objects.land))
        .attr("class", "land")
        .attr("d", path)



    // projection.clipExtent([[100,100],[120,120]], map)


    // svg.insert("path", ".graticule")
    //     .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
    //     .attr("class", "boundary")
    //     .attr("d", path);
  });

  d3.select(self.frameElement).style("height", height + "px");


    var x=0

    var drawHemisphere = function(psi) {
      projection.rotate([psi*180/Math.PI*365.25, -90+23.4*Math.sin(psi), 23.4*Math.cos(psi)])

      path.projection(projection)

      abc.attr("d", path);
      map2.attr("d", path)

      console.log(psi);

    }
    var drawSpiral = function(timestamp) {



      psi+= Math.PI/12/600

      drawHemisphere(psi)


      x= window.requestAnimationFrame(drawSpiral)

    }

    drawSpiral(0)
    var cancel = function() {
      window.cancelAnimationFrame(x)
    }







    </script>


</body>




</html>
