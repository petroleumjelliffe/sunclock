<html>
<head>
  <script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
</head>

<body>
  <svg width="720" height="350">

  </svg>
  <script src="https://d3js.org/d3.v4.min.js"></script>

  <script>

    var globe = function(spec) {

      spec = spec || {}
      spec.lat = spec.lat||40.6816778, //NYC
      spec.lon = spec.lon||-73.9962808, //NYC
      // spec.timestamp = spec.timestamp||new Date();

      spec.sun = {}
      spec.moon = {}

      var that = {}

      var getArcs = function(date, callback) {
        console.log("getArcs");
        $.getJSON("sunmoon/day", {
          lat: spec.lat,
          lon: spec.lon,
          timestamp: date},
          function(data) {
            // spec.moon[date] = data.map(function(item) {
            //   return item.moon
            // })
            spec.sun[date] = data.map(function(item){
              return {
                "date" : item.timestamp,
                "azimuth":item.sun.azimuth,
                "altitude":item.sun.altitude
              }
            })
            spec.moon[date] = data.map(function(item){
              return {
                "date" : item.timestamp,
                "azimuth":item.moon.azimuth,
                "altitude":item.moon.altitude
              }
            })
            // console.log(spec.sun[date]);
            console.log("updated arcs");

            //cosure for after the data is processed
            callback();
        })
      }

      var drawArc = function(thing) {
        return function(date, callback) {

          //does arc[date] exist?
          if (thing[date]  === undefined) {
            console.log(date+" is new");
            getArcs(date, function() {
              return callback(thing[date])
              console.log("after drawArc callback");
              console.log(thing);

            })
          } else {
            console.log(date+" already exists drawArc");
            console.log(thing);
            return callback(thing[date])

          }
        }
      }
      that.sunArc = drawArc(spec.sun)

      that.moonArc = drawArc(spec.moon)

      that.log = function() {
        console.log(spec.sun);
        console.log(now.toISOString());
        console.log(spec.sun[now.toISOString()]);
        return Object.keys(spec.sun)
      }

      return that;
    }

    var newObj = new globe({})
    //load arcs for today, or given day

    var date = new Date(2017,1,18)
    date.setHours(0,0,0,0)
    console.log(date);


    var svg = d3.select("svg"),
        margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var x = d3.scaleLinear()
          .domain([-Math.PI, Math.PI]) //azimuth
          .range([0, width]), //x
        y = d3.scaleLinear()
          .domain([-1,1]) //altitude
          .range([height, 0]) //y

    var line = d3.line()
      .x(function(d) {
        // console.log(dAz);
        // console.log(d.azimuth+dAz);
        return x(d.azimuth)
        // return x(d.azimuth)
      })
      .y(function(d) {
        // console.log((d.altitude)*180/Math.PI);
        return y(Math.sin(d.altitude))
        // return y(Math.sin(d.altitude))
      })

    //draw x axis
    g.append("g")
         .attr("transform", "translate(0," + height + ")")
         .call(d3.axisBottom(x))


    //draw y axis
    g.append("g")
      .call(d3.axisLeft(y))
      .append("text")
      .attr("fill", "#000")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")
      .attr("text-anchor", "end")
      .text("Altitude");

    var format = d3.timeFormat("%Y-%m-%d")

    var array = []
    var drawline = function(arc) {
      console.log("drawline called");
      console.log(arc);

      var dAz = Math.PI - arc[0].azimuth

      var corrected = arc.map(function(item) {
        item.azimuth = (item.azimuth  +dAz+ Math.PI )%(2*Math.PI)-Math.PI-dAz
        return item
      })

      array = array.concat(corrected)

      var group = svg.selectAll("path.test")
        .data(groupedArcs, function(d) {return d.key})
        .enter().append("path")
        .attr("d", function(d){console.log(d); return line(d.values)})
        .attr("fill", "none")
        .attr("stroke", "steelblue")
        .attr("stroke-linejoin", "round")
        .attr("stroke-linecap", "round")
        .attr("stroke-width", 1.5)
    }

    // var groupedArcs = d3.nest()
    //   .key(function(d) {return format(new Date(d.date))})
    //   .entries(array)


    //draw sunarc for today
    // newObj.sunArc(date, drawline)
    newObj.moonArc(date, drawline)

    date.setHours(24)
    // newObj.sunArc(date, drawline)
    newObj.moonArc(date, drawline)

    date.setHours(24)
    // newObj.sunArc(date, drawline)
    newObj.moonArc(date, drawline)

    // console.log(groupedArcs);

    // now = time
    // time += 15 minutes
    // today = time.day
    //
    // //center lines
    // //x(angle of sun at midnight) = 0
    // //offset = x(angle of the sun ormoon at now) - x(angle of sun at midnight)
    // //tomorrow offset = offset +1
    // //yesterday offset = offset -1
    // yesterday = time-24
    // tomorrow= time+24





  </script>


</body>


</html>
