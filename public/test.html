<html>
<head>
  <script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
</head>

<body>
  <svg width="720" height="350">

  </svg>
  <script src="https://d3js.org/d3.v4.min.js"></script>

  <script>

    var globe = function(spec) {

      spec = spec || {}
      spec.lat = spec.lat||40.6816778, //NYC
      spec.lon = spec.lon||-73.9962808, //NYC
      // spec.timestamp = spec.timestamp||new Date();

      spec.sun = {}
      spec.moon = {}

      var that = {}

      var getArcs = function(date, callback) {
        console.log("getArcs");
        $.getJSON("sunmoon/day", {
          lat: spec.lat,
          lon: spec.lon,
          timestamp: date},
          function(data) {
            // spec.moon[date] = data.map(function(item) {
            //   return item.moon
            // })
            spec.sun[date] = data.map(function(item){
              return {
                "date" : item.timestamp,
                "azimuth":item.sun.azimuth,
                "altitude":item.sun.altitude
              }
            })
            spec.moon[date] = data.map(function(item){
              return {
                "date" : item.timestamp,
                "azimuth":item.moon.azimuth,
                "altitude":item.moon.altitude
              }
            })
            // console.log(spec.sun[date]);
            console.log("updated arcs");

            //cosure for after the data is processed
            callback();
        })
      }

      var drawArc = function(thing) {
        return function(date, callback) {

          //does arc[date] exist?
          if (thing[date]  === undefined) {
            console.log(date+" is new");
            getArcs(date, function() {
              return callback(thing[date])
              console.log("after drawArc callback");
            })
          } else {
            console.log(date+" already exists drawArc");

            return callback(thing[date])

          }
        }
      }
      that.sunArc = drawArc(spec.sun)

      that.moonArc = drawArc(spec.moon)

      that.log = function() {
        console.log(spec.sun);
        console.log(now.toISOString());
        console.log(spec.sun[now.toISOString()]);
        return Object.keys(spec.sun)
      }

      return that;
    }

    var newObj = new globe({})
    //load arcs for today, or given day

    var date = new Date(2017,1,18)
    date.setHours(0,0,0,0)
    console.log(date);


    var svg = d3.select("svg"),
        margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var x = d3.scaleLinear()
          .domain([-Math.PI, Math.PI]) //azimuth
          .range([0, width]), //x
        y = d3.scaleLinear()
          .domain([-1,1]) //altitude
          .range([height, 0]) //y

    var line = d3.line()
      .x(function(d) {
        // console.log(dAz);
        // console.log(d.azimuth+dAz);
        return x(d.azimuth)
        // return x(d.azimuth)
      })
      .y(function(d) {
        // console.log((d.altitude)*180/Math.PI);
        return y(Math.sin(d.altitude))
        // return y(Math.sin(d.altitude))
      })

      // //draw x axis
      // g.append("g")
      //      .attr("transform", "translate(0," + height + ")")
      //      .call(d3.axisBottom(x))
      //
      //
      // //draw y axis
      //  g.append("g")
      //      .call(d3.axisLeft(y))
      //    .append("text")
      //      .attr("fill", "#000")
      //      .attr("transform", "rotate(-90)")
      //      .attr("y", 6)
      //      .attr("dy", "0.71em")
      //      .attr("text-anchor", "end")
      //      .text("Price ($)");


      var data = [{
        key:"2017-02-11",
        values: [{
          x:1, y:1
        }, {
          x:2, y:2
        }]
      }, {
        key:"2017-02-12",
        values: [{
          x:1, y:1
        }, {
          x:2, y:2
        }]
      }, {
        key:"2017-02-13",
        values: [{
          x:1, y:1
        }, {
          x:2, y:2
        }]
      }]

      var line2 = d3.line()
        .x(function(d) {
          console.log(d.x);
          return x(d.x)
        })
        .y(function(d) {
          console.log(d.y);
          return y(d.y)
        })
      var svg = d3.select("svg")

      var group = svg.selectAll("path.test")
        .data(data, function(d) {return d.key})
        .enter().append("path")
        .attr("d", function(d){console.log(d); return line2(d.values)})

      // var paths = group.selectAll("path")
      //   .data(function(d,i) {console.log(d.key);return d})
      //   .enter().append("path")

    //  var graph = x.selectAll("path")
    //   .enter().append("path")
    //   .data(function(d) {return d.values})
    //   .attr("class", "test")
    //     .attr("d", line)

    // var paths2 = svg.selectAll("path").append("path")
    //   .data(function(d) {console.log(d); return d})
      // .enter().append("path")
      // .attr("d",line)

      // .selectAll("circle") //no paths yet
      //
      //  .enter().append("circle")
      //  .data(function(d)  {
      //    console.log(d);
      //    return d
      //  })
      //  .attr("cx",function(d) {console.log(d); d[0]} )
      //  .attr("cy",function(d) {d[1]} )
      //  .attr("r",3)
      //  .exit().remove()

       //function to return an array per parent item
      //  <g> //d3.select("g")
      //    <g transform offset>//d3.select("g").selectAll("g")  //parentNode is g
      //      <path "sun 2017-02-11" transform -width></path>
      //      <path "sun 2017-02-12"></path>
      //      <path "sun 2017-02-13" transform +width></path>
      //    </g>
      //    <g>
      //      <path "moon 2017-02-11"></path>
      //      <path "moon 2017-02-12"></path>
      //      <path "moon 2017-02-13"></path>
      //   </g>
      // </g>



      //  .data([ //function to return an array per parent item
       //
      //    {
      //      key:"2017-2-11",
      //      values: [{
      //        date: new Date(2017,1,11,0,0,0),
      //        azimuth: -Math.PI/2,
      //        altitude: Math.PI/6
      //      }, {
      //        date: new Date(2017,1,11,12,0,0),
      //        azimuth: Math.PI/2,
      //        altitude: Math.PI/6
      //      }]
      //    }, {
      //      key:"2017-02-12",
      //      values: [
      //      {
      //        date: new Date(2017,1,12,0,0,0),
      //        azimuth: -Math.PI/2,
      //        altitude: Math.PI/8
      //      },  {
      //        date: new Date(2017,1,12,12,0,0),
      //        azimuth: Math.PI/2,
      //        altitude: Math.PI/8
      //      }]
      //    }])
       .enter()
       .attr("d", line)
       .attr("transform", "translate( offset ,0)")
       .attr("fill", "none")
       .attr("stroke", "steelblue")
       .attr("stroke-linejoin", "round")
       .attr("stroke-linecap", "round")
       .attr("stroke-width", 1.5)
      //  .exit().remove()


     var drawline = function(arc) {
       console.log(arc);

       var dAz = Math.PI - arc[0].azimuth

       var corrected = arc.map(function(item) {
         item.azimuth = (item.azimuth  +dAz+ Math.PI )%(2*Math.PI)-Math.PI-dAz
         return item
       })
       console.log("inside drawarc callback");
       console.log(Math.PI - arc[0].azimuth);

      return (g.append("path")
         .attr("class", "abc")
         .datum(arc)
         .attr("fill", "none")
         .attr("stroke", "steelblue")
         .attr("stroke-linejoin", "round")
         .attr("stroke-linecap", "round")
         .attr("stroke-width", 1.5)
         .attr("d", line))
    }
    // //draw sunarc for today
    // newObj.sunArc(date, drawline)
    // var b = []
    // newObj.moonArc(date, function(arc) {
    //   b.push(drawline(arc))
    // })
    // // b.attr("transform", "translate(" +0+",0)")
    //
    // date.setHours(24)
    // newObj.moonArc(date, function(arc) {
    //   var newline = drawline(arc)
    //   newline.attr("transform", "translate("+x(Math.PI)+",0)")
    //   b.push(newline)
    // })

    // now = time
    // time += 15 minutes
    // today = time.day
    //
    // //center lines
    // //x(angle of sun at midnight) = 0
    // //offset = x(angle of the sun ormoon at now) - x(angle of sun at midnight)
    // //tomorrow offset = offset +1
    // //yesterday offset = offset -1
    // yesterday = time-24
    // tomorrow= time+24





  </script>


</body>


</html>
