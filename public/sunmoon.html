<html>
<head>


<script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
<link rel="stylesheet" type="text/css" href="./css/gradients.css"/>
</head>

<body>
  <canvas id="topCanvas" width="144" height="168" style="border:1px solid #d3d3d3;"></canvas>
  <div id="globeContainer">
  <canvas id="globeCanvas" width="800" height="400" style="border:1px solid #d3d3d3;"></canvas>
  <form id="controls">
    <label>Time of day</label>
    <input id="time_of_day" name="time" type="range" min="0" max="24" step=".25">

    <label>Angle</label>
    <input id="azimuth" name="time" type="range" min="-1" max="1" step=".125">

  </form>

  </div>

  <canvas id="myCanvas" width="1600" height="400" style=""></canvas>
  <!-- <canvas id="myCanvas" width="144" height="56" style="border:1px solid #d3d3d3;"></canvas> -->

  <!-- <p style="background:#f00;"><img src="img/072075348d410a448a70855677fedfa1.jpg" height="800" width="400"/></p> -->
  <script>
    $("#controls").on("input", "input", function() {
      console.log(this.value);


    })
  </script>
  <script>

  //translate polar coords as seen from side
  function xySide(azimuth, altitude, c, dAz) {
    var x = ((azimuth+dAz) / 2 / Math.PI * c.width) + c.width/2;
    var y = c.height - (Math.sin(altitude) * c.height);

    return {
      x: x,
      y: y
    };
  }
  //draw polar coords as seen from above
  function xyTop(azimuth, altitude, c, dAz) {
    dAz += Math.PI/2;  //correct for diff in 0ยบ between the canvas and compass

    var r1 = Math.cos(altitude) * c.width/2
    var x = r1 * Math.cos(azimuth+dAz) + c.width/2
    var y = r1 * Math.sin(azimuth+dAz) + c.height/2

    return {
      x: x,
      y: y
    };
  }

  function halfGlobe(azimuth, altitude, c, dAz) {
    dAz += Math.PI;  //correct for diff in 0ยบ between the canvas and compass

    var r1 = -c.height
    var x = r1 * Math.cos(altitude) * Math.cos(azimuth+dAz) + c.width/2
    var y = r1 * Math.sin(altitude) + c.height

    return {
      x: x,
      y: y
    };
  }

  function drawDisc(func, pos, color, canvas, dAz) {
    console.log(canvas);

    var ctx = canvas.getContext("2d");


    var p = func(pos.azimuth, pos.altitude, canvas, dAz)
    var r = canvas.height/10

    // ctx.save();
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, r, 0, 2 * Math.PI);
    ctx.closePath();
    ctx.fill();
    // ctx.restore();
  }

  function drawMoon(func, pos, src, ctx, c, dAz) {
    var p = func(pos.moon.azimuth, pos.moon.altitude, c, dAz)
    var r = c.height/10
    var apparentAngle  = pos.moonPhase.angle - pos.moon.parallacticAngle - Math.PI/2;

    var img = document.createElement('IMG');
    //draw image after loading
    img.onload = function () {
      //assume spritesheet is made up of squares
      //h/w should be # of sprites
      var sprites = parseInt(img.naturalWidth / img.naturalHeight);
      var spriteOffset = Math.ceil(pos.moonPhase.phase*sprites)%sprites-1
      // console.log(sprites)
      // console.log(spriteOffset)
      ctx.save()
      ctx.translate(p.x, p.y)
      ctx.rotate(apparentAngle);
      ctx.translate(-p.x, -p.y);
      ctx.globalCompositeOperation = 'screen';
      ctx.drawImage(this, spriteOffset * img.naturalHeight , 0, img.naturalHeight, img.naturalHeight, p.x-r,p.y-r, 2*r, 2*r);
      ctx.restore();
    }


    // Specify the src to load the image
    img.src = src; //triggers onLoad()
  }

  function drawShadow(pos, src, ctx, c, dAz) {
    // dAz+= Math.PI/2;

    var img = document.createElement('IMG');
    //draw image after loading
    img.onload = function () {
      var r =  c.height/ img.naturalHeight*.5
      var h = c.height/Math.tan(pos.altitude)*.5
      var w = r * img.naturalWidth

      console.log("shadow");
      ctx.save()
      console.log(w);
      //center context on origin
      ctx.translate((c.width/2), (c.height/2));
      //rotate to opposite side of sun's azimuth
      ctx.rotate(pos.azimuth+dAz);
      ctx.translate((-c.width/2), (-c.height/2));

      // ctx.globalCompositeOperation = 'screen';
      // draw image with feet centered on center of image
      ctx.drawImage(this, 0,0, img.naturalWidth, img.naturalHeight, (c.width/2)-w/2,(c.height/2)-h, w, h);
      ctx.restore();
    }
    // Specify the src to load the image
    img.src = src; //triggers onLoad()
  }

  //draw paths of sun and moon
  function drawArc(func, points, ctx, c, dAz) {
    console.log(points);
    ctx.save();
    ctx.beginPath();
    points.reduce(function(p1, p2, i, array) {
      if (i>0) {
        var xy1 = func(p1.azimuth, p1.altitude, c, dAz)
        ctx.moveTo(xy1.x,xy1.y);

        var xy2 = func(p2.azimuth, p2.altitude, c, dAz)
        ctx.lineTo(xy2.x,xy2.y);
        ctx.stroke();
      }

      return p2;
    }, {} );
    ctx.restore();
  }

  var labels = {
    "north": {
      "azimuth":0,
      "altitude":0,
      "label":"N"
    },
    "east": {
      "azimuth":90,
      "altitude":0,
      "label":"E"
    },
    "south": {
      "azimuth":180,
      "altitude":0,
      "label":"S"
    },
    "west": {
      "azimuth":270,
      "altitude":0,
      "label":"W"
    }
  }


  var drawSide = function(canvas, arcPoints, position, dAz) {
    var ctx =canvas.getContext("2d");
    console.log(canvas);
    ctx.lineWidth = 0.25;
    ctx.strokeStyle = "#ffffff";

    //draw altitude lines
    for(var i=0; i<6; i++) {
      var y = Math.ceil(canvas.height* (1 - Math.sin(Math.PI* i /12))) +0.5;
      ctx.moveTo(0, y);
      ctx.lineTo(canvas.width, y);
      ctx.stroke();
    }
    //set up side view
    ctx.fillStyle = "white";
    ctx.textAlign = "center";
    //draw compass direction labels
    ctx.font = (canvas.height/56*10)+"px Arial";
    console.log("width: "+canvas.width);
    ctx.fillText("E", canvas.width * Math.PI/2 / (2 * Math.PI), canvas.height);
    ctx.fillText("S", canvas.width * 2 * Math.PI/2/ (2 * Math.PI), canvas.height);
    ctx.fillText("W", canvas.width * 3 * Math.PI/2/ (2 * Math.PI), canvas.height);

    //draw paths above horizon
    drawArc(xySide, arcPoints.sun, ctx, canvas, dAz);
    drawArc(xySide, arcPoints.moon, ctx, canvas, dAz);

    //draw sun and moon
    drawMoon(xySide, position, "img/phases-sheet.png", ctx, canvas, dAz)
    drawDisc(xySide, position.sun, "#fdb813", canvas, dAz);
    // drawDisc(xySide, data.moon, "#ccc", c)
  }




    $.getJSON("/sunmoon/positions", function(arcPoints) {
      console.log(arcPoints);
      // var c = document.getElementById("myCanvas");
      var sideCanvas = $("#myCanvas");

      // var ctx = c[0].getContext("2d");

      var topCanvas = $("#topCanvas");
      var topCtx = topCanvas[0].getContext("2d");

      var globeCanvas = $("#globeCanvas");
      var globeCtx = globeCanvas[0].getContext("2d");

      // var colors = getColors(ctx, c.width(), c.height());

      $.getJSON("/sunmoon/now", function(data) {
        console.log(data);

        //draw sky
        console.log(data.partOfDay);

        //apply sky gradient based on what part of day it is
        sideCanvas.addClass(data.partOfDay);

        drawSide(sideCanvas[0], arcPoints, data, 0);

        // globeCanvas.addClass(data.partOfDay);
        $("#globeContainer").addClass(data.partOfDay);

        // ctx.fillStyle = colors[data.partOfDay];
        topCtx.fillStyle="#ccc"
        // globeCtx.fillStyle="#7ec0ee"
        topCtx.fillRect(0,0,topCanvas.width(), topCanvas.height())
        // globeCtx.fillRect(0,0,globeCanvas.width, globeCanvas.height)
        // console.log(data.partOfDay);
        // ctx.fillRect(0, 0, c.width, c.height);
        //draw top view
        topCtx.beginPath();
        topCtx.arc(topCanvas.width()/2,topCanvas.height()/2,topCanvas.width()/2,0,2*Math.PI);
        topCtx.stroke();


        var y= Math.PI;
        var centeredSun = 3*Math.PI/2 - data.sun.azimuth;
        var leftSun = 2*Math.PI/2 - data.sun.azimuth;

        drawArc(xyTop, arcPoints.sun, topCtx, topCanvas[0], y);
        drawArc(xyTop, arcPoints.moon, topCtx, topCanvas[0], y);

        drawShadow(data.sun,"img/shadow.png", topCtx, topCanvas[0], y)

        drawMoon(xyTop, data, "img/phases-sheet.png", topCtx, topCanvas[0], y)
        drawDisc(xyTop, data.sun, "#fdb813", topCanvas[0], y);
        // drawDisc(xyTop, data.moon, "#ccc", topCanvas[0])


        globeCtx.strokeStyle = "#ffffff";
        for(var i=0; i<6; i++) {
          var y = Math.ceil(globeCanvas.height* (1 - Math.sin(Math.PI* i /12))) +0.5;
          globeCtx.moveTo(0, y);
          globeCtx.lineTo(globeCanvas.width, y);
          globeCtx.stroke();
        }

        //draw globe view
        globeCtx.beginPath();
        globeCtx.arc(globeCanvas.width()/2,globeCanvas.height(),globeCanvas.width()/2,0,2*Math.PI);
        globeCtx.stroke();

        drawArc(halfGlobe, arcPoints.sun, globeCtx, globeCanvas[0], leftSun);
        drawArc(halfGlobe, arcPoints.moon, globeCtx, globeCanvas[0], leftSun);
        drawMoon(halfGlobe, data, "img/phases-sheet.png", globeCtx, globeCanvas[0], leftSun)
        drawDisc(halfGlobe, data.sun, "#fdb813", globeCanvas[0], leftSun);

        //draw globe view
        globeCtx.beginPath();
        globeCtx.moveTo(globeCanvas.width()/2, globeCanvas.height());
        var sunLeftPos = halfGlobe(data.sun.azimuth, data.sun.altitude, globeCanvas[0],leftSun);
        globeCtx.lineTo(sunLeftPos.x, sunLeftPos.y)
        console.log(sunLeftPos);
        console.log(data.sun.altitude/Math.PI*180);
        globeCtx.stroke();

      })

    });

  </script>

</body>




</html>
