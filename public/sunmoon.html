<html>
<head>


<script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
</head>

<body>
  <canvas id="myCanvas" width="800" height="300" style="border:1px solid #d3d3d3;"></canvas>
  <!-- <canvas id="myCanvas" width="144" height="56" style="border:1px solid #d3d3d3;"></canvas> -->

  <!-- <p style="background:#f00;"><img src="img/072075348d410a448a70855677fedfa1.jpg" height="800" width="400"/></p> -->

  <script>
    var getColors = function(ctx, w, h) {
      var colors = {
      //   sunrise	:
        "goldenHourEnd" : "#7ec0ee",
      //   goldenHour
        "sunsetStart" : "#F60",
      //   sunset
      //   dusk
         "nauticalDusk" : "#f00",
        "night" : "#280137"
      //   nadir
      //   nightEnd
      //   nauticalDawn
      //   dawn
      }


      var my_gradient=ctx.createLinearGradient(0,0,0,h);
      my_gradient.addColorStop(0.95,"blue");
      my_gradient.addColorStop(1.0,"#FFA500");
      colors.dusk = my_gradient;


      return colors;
    }


    $.getJSON("/sunmoon", function(arcPoints) {
      console.log(arcPoints);
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");

      var colors = getColors(ctx, c.width, c.height);

      $.getJSON("/now", function(data) {
        console.log(data);

        function drawDisc(pos, color, ctx) {
          var x1 = (pos.azimuth / 2 / Math.PI * c.width) + c.width/2;
          var y1 = c.height - ((pos.altitude * 2 / Math.PI) * c.height);
          var r = c.height/10

          ctx.save();
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(x1, y1, r, 0, 2 * Math.PI);
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        }

        function drawImageDisc(pos, src, ctx) {
          var x1 = (pos.azimuth / 2 / Math.PI * c.width) + c.width/2;
          var y1 = c.height - ((pos.altitude * 2 / Math.PI) * c.height);
          var r = c.height/10
          var apparentAngle  = data.moonPhase.angle - pos.parallacticAngle;

          var img = document.createElement('IMG');
          var spriteOffset = Math.ceil(data.moonPhase.phase*8)%8
          //draw image after loading
          img.onload = function () {
            console.log(spriteOffset)
            ctx.save()
            ctx.translate(x1, y1)
            ctx.rotate(apparentAngle);
          	ctx.translate(-x1, -y1);
            ctx.drawImage(this, spriteOffset * 316 , 0, img.naturalHeight, img.naturalHeight, x1-r,y1-r, 2*r, 2*r);
            ctx.restore();
          }

          // Specify the src to load the image
          img.src = src; //triggers onLoad()
        }


        //draw sky
        ctx.fillStyle = colors[data.partOfDay];
        console.log(data.partOfDay);

        // ctx.fillStyle = "#7ec0ee";
        ctx.fillRect(0, 0, c.width, c.height);

        ctx.lineWidth = 0.25;
        ctx.strokeStyle = "#ffffff";



        //draw altitude lines
        for(var i=0; i<6; i++) {
          var y = Math.ceil(c.height* (1 - Math.sin(Math.PI* i /12))) +0.5;
          ctx.moveTo(0, y);
          ctx.lineTo(c.width, y);

          ctx.stroke();

        }
        ctx.fillStyle = "white";
        ctx.textAlign = "center";

        ctx.font = c.height/56*10+"px Arial";
        ctx.fillText("E",c.width/4,c.height);
        ctx.fillText("S",c.width/2,c.height);
        ctx.fillText("W",c.width/4*3,c.height);


        //draw paths of sun and moon
        function drawArc(points, ctx) {
          console.log(arcPoints);
          ctx.save();
          ctx.beginPath();
          points.reduce(function(p1, p2, i, array) {
            if (i>0) {
              x1 = (p1.azimuth / 2 / Math.PI * c.width) + c.width/2;
              y1 = c.height - ((p1.altitude * 2 / Math.PI) * c.height);
              ctx.moveTo(x1,y1);

              x2 = (p2.azimuth / 2 / Math.PI * c.width) + c.width/2;
              y2 = c.height - ((p2.altitude * 2 / Math.PI) * c.height);

              ctx.lineTo(x2,y2);
              ctx.stroke();
            }

            return p2;
          }, {} );
          ctx.restore();
        }

        drawArc(arcPoints.sun, ctx);
        drawArc(arcPoints.moon, ctx);

        //draw sun and moon
        drawDisc(data.sun, "#fdb813", ctx);
        drawImageDisc(data.moon, "img/moon_phases-sheet.png", ctx)

      })

    });

  </script>

</body>




</html>
