<html>
<head>


<script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
</head>

<body>
  <canvas id="topCanvas" width="144" height="168" style="border:1px solid #d3d3d3;"></canvas>
  <canvas id="myCanvas" width="800" height="300" style="border:1px solid #d3d3d3;"></canvas>
  <!-- <canvas id="myCanvas" width="144" height="56" style="border:1px solid #d3d3d3;"></canvas> -->

  <!-- <p style="background:#f00;"><img src="img/072075348d410a448a70855677fedfa1.jpg" height="800" width="400"/></p> -->

  <script>
    var getColors = function(ctx, w, h) {
      var colors = {
      //   sunrise	:
        "goldenHourEnd" : "#7ec0ee",
         "goldenHour" : "#7ec0ee",
        "sunsetStart" : "#F60",
      //   sunset
      //   dusk
         "nauticalDusk" : "#f00",
        "night" : "#280137"
      //   nadir
      //   nightEnd
      //   nauticalDawn
      //   dawn
      }

      var my_gradient=ctx.createLinearGradient(0,0,0,h);
      my_gradient.addColorStop(0.95,"blue");
      my_gradient.addColorStop(1.0,"#FFA500");
      colors.dusk = my_gradient;

      return colors;
    }


    $.getJSON("/sunmoon", function(arcPoints) {
      console.log(arcPoints);
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");

      var topCanvas = document.getElementById("topCanvas");
      var topCtx = topCanvas.getContext("2d");

      var colors = getColors(ctx, c.width, c.height);

      $.getJSON("/now", function(data) {
        console.log(data);
        //translate polar coords as seen from side
        function xySide(azimuth, altitude, c) {
          var obj ={}
          obj.x = (azimuth / 2 / Math.PI * c.width) + c.width/2;
          obj.y = c.height - ((altitude * 2 / Math.PI) * c.height);

          return obj;
        }
        //draw polar coords as seen from above
        function xyTop(azimuth, altitude, c) {
          var obj ={}
          var dAz =  Math.PI/2;  //correct for diff in 0ยบ between the canvas and compass

          var r1 = Math.cos(altitude) * c.width/2
          obj.x = r1 * Math.cos(azimuth+dAz) + c.width/2
          obj.y = r1 * Math.sin(azimuth+dAz) + c.height/2

          return obj;
        }

        function drawDisc(func, pos, color, ctx, c) {
          var p = func(pos.azimuth, pos.altitude, c)
          var r = c.height/10

          ctx.save();
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(p.x, p.y, r, 0, 2 * Math.PI);
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        }

        function drawImageDisc(func, pos, src, ctx) {
          var p = func(pos.azimuth, pos.altitude, c)
          var r = c.height/10
          var apparentAngle  = data.moonPhase.angle - pos.parallacticAngle;

          var img = document.createElement('IMG');
          var spriteOffset = Math.ceil(data.moonPhase.phase*8)%8
          //draw image after loading
          img.onload = function () {
            console.log(spriteOffset)
            ctx.save()
            ctx.translate(x1, y1)
            ctx.rotate(apparentAngle);
          	ctx.translate(-x1, -y1);
            ctx.drawImage(this, spriteOffset * 316 , 0, img.naturalHeight, img.naturalHeight, x1-r,y1-r, 2*r, 2*r);
            ctx.restore();
          }

          // Specify the src to load the image
          img.src = src; //triggers onLoad()
        }

        //draw paths of sun and moon
        function drawArc(func, points, ctx, c) {
          console.log(arcPoints);
          ctx.save();
          ctx.beginPath();
          points.reduce(function(p1, p2, i, array) {
            if (i>0) {
              var xy1 = func(p1.azimuth, p1.altitude, c)
              ctx.moveTo(xy1.x,xy1.y);

              var xy2 = func(p2.azimuth, p2.altitude, c)
              ctx.lineTo(xy2.x,xy2.y);
              ctx.stroke();
            }

            return p2;
          }, {} );
          ctx.restore();
        }

        //draw sky
        ctx.fillStyle = colors[data.partOfDay];
        // console.log(data.partOfDay);
        ctx.fillRect(0, 0, c.width, c.height);
        ctx.lineWidth = 0.25;
        ctx.strokeStyle = "#ffffff";

        //draw altitude lines
        for(var i=0; i<6; i++) {
          var y = Math.ceil(c.height* (1 - Math.sin(Math.PI* i /12))) +0.5;
          ctx.moveTo(0, y);
          ctx.lineTo(c.width, y);
          ctx.stroke();
        }
        //set up side view
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        //draw compass direction labels
        ctx.font = c.height/56*10+"px Arial";
        ctx.fillText("E",c.width/4,c.height);
        ctx.fillText("S",c.width/2,c.height);
        ctx.fillText("W",c.width/4*3,c.height);

        //draw paths above horizon
        drawArc(xySide, arcPoints.sun, ctx, c);
        drawArc(xySide, arcPoints.moon, ctx, c);

        //draw sun and moon
        drawDisc(xySide, data.sun, "#fdb813", ctx, c);
        drawImageDisc(xySide, data.moon, "img/moon_phases-sheet.png", ctx)

        //draw top view
        topCtx.beginPath();
        topCtx.arc(topCanvas.width/2,topCanvas.height/2,topCanvas.width/2,0,2*Math.PI);
        topCtx.stroke();

        drawArc(xyTop, arcPoints.sun, topCtx, topCanvas);
        drawArc(xyTop, arcPoints.moon, topCtx, topCanvas);
        drawDisc(xyTop, data.sun, "#fdb813", topCtx, topCanvas);
        drawImageDisc(xyTop, data.moon, "img/moon_phases-sheet.png", topCtx)



      })

    });

  </script>

</body>




</html>
